<!DOCTYPE html>
<html>

<head>
    <title>MQTT App</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <!-- Paho MQTT JavaScript client -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js" type="text/javascript"></script>

    <style>
        #eventLog {
            font-family: monospace;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Shadow Service Demo App</h1>
        <div class="row">
            <div class="col">
                <input type="text" id="broker" class="form-control" value="broker.hivemq.com"
                    placeholder="Broker Address">
            </div>
            <div class="col">
                <input type="text" id="port" class="form-control" value="8000" placeholder="Broker Port">
            </div>
            <div class="col">
                <button id="connect" class="btn btn-primary">Connect</button>
            </div>
            <div class="col">
                <p id="state">Disconnected</p>
            </div>
        </div>

        <hr>
        <div class="row mb-3">
            <div class="col">
                <input type="text" id="nodeId" class="form-control" placeholder="Node ID">
            </div>
            <div class="col">
                <button id="subscribe" class="btn btn-secondary">Subscribe</button>
                <button id="unsubscribe" class="btn btn-secondary">Unsubscribe</button>
            </div>
            <div class="col">
                <button id="bind" class="btn btn-secondary">Bind</button>
                <button id="unbind" class="btn btn-secondary">Unbind</button>
            </div>
            <div class="col text-right">
                <button id="togglePrettyPrint" class="btn btn-secondary">Toggle Pretty Print</button>
            </div>
        </div>

        <div class="row">
            <div class="col pr-3">
                <table id="dataTable" class="table">
                    <thead>
                        <tr>
                            <th>Rule ID</th>
                            <th>Rule state</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Table data will be filled in here -->
                    </tbody>
                </table>
            </div>
            <div class="col pl-3">
                <textarea id="eventLog" class="form-control" rows="10" readonly></textarea>
            </div>
        </div>
    </div>

    <script>
        var client;
        var rules = {};
        var prettyPrintEventLog = false;

        document.getElementById('connect').addEventListener('click', connect);

        function connect() {
            console.log("Connecting...");
            var broker = document.getElementById('broker').value;
            var port = Number(document.getElementById('port').value);
            // Create a client instance
            client = new Paho.MQTT.Client(broker, port, "opaleni_event_tester");
            client.onConnectionLost = onConnectionLost;
            client.onMessageArrived = onMessageArrived;

            // Connect the client
            client.connect({ onSuccess: onConnect, onFailure: onFailure });
        }

        function disconnect() {
            console.log("Disconnecting...");
            client.disconnect();

            document.getElementById('state').textContent = 'Disconnected';
            var connectButton = document.getElementById('connect');
            connectButton.textContent = 'Connect';
            connectButton.removeEventListener('click', disconnect);
            connectButton.addEventListener('click', connect);
            connectButton.classList.remove('btn-danger');
            connectButton.classList.add('btn-primary');
        }

        function onConnect() {
            console.log("onConnect");
            document.getElementById('state').textContent = 'Connected';

            var connectButton = document.getElementById('connect');
            connectButton.textContent = 'Disconnect';
            connectButton.removeEventListener('click', connect);
            connectButton.addEventListener('click', disconnect);
            connectButton.classList.remove('btn-primary');
            connectButton.classList.add('btn-danger');
        }

        function onFailure(invocationContext, errorCode, errorMessage) {
            console.log("onFailure");
            document.getElementById('state').textContent = 'Failed to connect: ' + errorMessage;
        }

        // Called when the client loses its connection
        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                console.log("onConnectionLost:" + responseObject.errorMessage);

                document.getElementById('state').textContent = 'Disconnected';
                var connectButton = document.getElementById('connect');
                connectButton.textContent = 'Connect';
                connectButton.removeEventListener('click', disconnect);
                connectButton.addEventListener('click', connect);
                connectButton.classList.remove('btn-danger');
                connectButton.classList.add('btn-primary');
            }
        }

        // Called when a message arrives
        function onMessageArrived(message) {
            console.log("onMessageArrived:" + message.payloadString);
            handleIncomingEvent(message);
        }

        document.getElementById('subscribe').addEventListener('click', subscribe);
        function subscribe() {
            var nodeId = document.getElementById('nodeId').value;
            if (!nodeId) {
                alert('Please enter a node ID');
                return;
            }

            var nodeTopic = 'shadow/' + nodeId;
            client.subscribe(nodeTopic + '/#');

            console.log('Subscribed to: ' + nodeTopic);
        }

        document.getElementById('unsubscribe').addEventListener('click', unsubscribe);
        function unsubscribe() {
            var nodeId = document.getElementById('nodeId').value;
            if (!nodeId) {
                alert('Please enter a node ID');
                return;
            }

            var nodeTopic = 'shadow/' + nodeId;
            client.unsubscribe(nodeTopic + '/#');

            console.log('Unsubscribed from: ' + nodeTopic);
        }

        document.getElementById('bind').addEventListener('click', bind);
        function bind() {
            var nodeId = document.getElementById('nodeId').value;
            if (!nodeId) {
                alert('Please enter a node ID');
                return;
            }

            var bindPayload = {
                "originatorAppId": "opaleni_event_tester",
            };

            var nodeTopic = 'shadow/' + nodeId;
            publishEvent(nodeTopic + '/bind', JSON.stringify(bindPayload));

            demoNodeId = nodeId;
            setInterval(demoRulesEngineUpdate, 3000);
            var event = {
                "features": {
                    "rulesEngine": {
                        "properties": demoRulesUpdatePayloads
                    }
                }
            };

            client.send('shadow/' + demoNodeId + '/deviceStateChange', JSON.stringify(event));
        }

        document.getElementById('unbind').addEventListener('click', unbind);
        function unbind() {
            var nodeId = document.getElementById('nodeId').value;
            if (!nodeId) {
                alert('Please enter a node ID');
                return;
            }

            var unbindPayload = {
                "originatorAppId": "opaleni_event_tester",
            };

            var nodeTopic = 'shadow/' + nodeId;

            publishEvent(nodeTopic + '/unbind', JSON.stringify(unbindPayload));

            demoNodeId = null;
            clearInterval(demoRulesEngineUpdate);
        }

        document.getElementById('togglePrettyPrint').addEventListener('click', togglePrettyPrint);
        function togglePrettyPrint() {
            prettyPrintEventLog = !prettyPrintEventLog;
            var prettyPrintButton = document.getElementById('togglePrettyPrint');
            prettyPrintButton.textContent = prettyPrintEventLog ? 'Disable Pretty Print' : 'Enable Pretty Print';
        }

        function publishEvent(topic, event) {
            var message = new Paho.MQTT.Message(event);
            message.destinationName = topic;
            client.send(message);

            console.log(message.destinationName + ' -> ' + message.payloadString);

            if (prettyPrintEventLog) {
                var eventPrettyStr = JSON.stringify(JSON.parse(event), null, 2);    
            } else {
                var eventPrettyStr = JSON.stringify(event);
            }
            
            console.log(message.destinationName + ' -> ' + event);
            document.getElementById('eventLog').value += message.destinationName + ' -> ' + eventPrettyStr + '\n';
        }

        function handleIncomingEvent(message) {
            function getRulesEngineProperties(message) {
                if (message.features && message.features.rulesEngine && message.features.rulesEngine.properties) {
                    return message.features.rulesEngine.properties;
                } else {
                    return null;
                }
            }

            console.log(message.destinationName + ' <- ' + message.payloadString);

            var event = JSON.parse(message.payloadString);
            
            if (prettyPrintEventLog) {
                var event_pretty_str = JSON.stringify(event, null, 2);    
            } else {
                var event_pretty_str = JSON.stringify(event);
            }

            var eventLog = document.getElementById('eventLog');
            eventLog.value += message.destinationName + ' <- ' + event_pretty_str + '\n';
            eventLog.scrollTop = eventLog.scrollHeight;

            var rulesEngineProperties = getRulesEngineProperties(event);
            if (rulesEngineProperties) {
                handleRulesEngineUpdate(rulesEngineProperties)
            }
        }

        function handleRulesEngineUpdate(rulesEngineProperties) {
            for (var ruleId in rulesEngineProperties) {
                var ruleStatus = rulesEngineProperties[ruleId].status;

                rules[ruleId] = ruleStatus;
            }

            updateRulesTable();
        }

        function updateRulesTable() {
            var table = document.getElementById('dataTable');
            var tbody = table.getElementsByTagName('tbody')[0];
            tbody.innerHTML = '';

            for (var ruleId in rules) {
                var row = tbody.insertRow();
                var cell1 = row.insertCell(0);
                var cell2 = row.insertCell(1);

                cell1.textContent = ruleId;
                cell2.textContent = rules[ruleId];
            }
        }

        var demoNodeId = null;
        var posInDemoRules = 0;
        var demoRulesUpdatePayloads = {
            "overtemperature": {
                "status": "active"
            },
            "overvoltage": {
                "status": "inactive"
            },
            "big bad": {
                "status": "active"
            }
        };

        function demoRulesEngineUpdate() {
            if (!demoNodeId) {
                return;
            }

            var ruleId = Object.keys(demoRulesUpdatePayloads)[posInDemoRules];
            var rulePayload = demoRulesUpdatePayloads[ruleId];

            if (rulePayload.status === "active") {
                demoRulesUpdatePayloads[ruleId].status = "inactive";
            } else {
                demoRulesUpdatePayloads[ruleId].status = "active";
            }

            var event = {
                "features": {
                    "rulesEngine": {
                        "properties": {
                            [ruleId]: rulePayload
                        }
                    }
                }
            };

            client.send('shadow/' + demoNodeId + '/deviceStateChange', JSON.stringify(event));

            posInDemoRules = (posInDemoRules + 1) % Object.keys(demoRulesUpdatePayloads).length;
        }
    </script>
</body>

</html>